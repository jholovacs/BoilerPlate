services:
  postgres:
    image: postgres:15-alpine
    pull_policy: if_not_present
    container_name: postgres-auth
    restart: unless-stopped
    environment:
      POSTGRES_USER: boilerplate
      POSTGRES_PASSWORD: SecurePassword123!
      POSTGRES_DB: BoilerPlateAuth
    ports:
      - "5432:5432"   # Required for make migrate; comment out for single-port deployment
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U boilerplate"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3-management-alpine
    pull_policy: if_not_present
    container_name: rabbitmq-auth
    restart: unless-stopped
    hostname: rabbitmq
    ports:
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: SecurePassword123!
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./rabbitmq/enabled_plugins:/etc/rabbitmq/enabled_plugins:ro
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  mongodb:
    image: mongo:7.0
    pull_policy: if_not_present
    container_name: mongodb-logs
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: SecurePassword123!
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    pull_policy: if_not_present
    container_name: otel-collector
    restart: unless-stopped
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
      - otel_collector_data:/var/lib/otel-collector
    healthcheck:
      test: ["CMD", "/otelcol-contrib", "--version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      mongodb:
        condition: service_healthy

  webapi:
    image: boilerplate-authentication-webapi:latest
    pull_policy: never
    build:
      context: .
      dockerfile: BoilerPlate.Authentication.WebApi/Dockerfile
    container_name: boilerplate-auth-api
    restart: unless-stopped
    environment:
      # PostgreSQL connection (using service name in docker-compose)
      - ConnectionStrings__PostgreSqlConnection=Host=postgres;Port=5432;Database=BoilerPlateAuth;Username=boilerplate;Password=SecurePassword123!
      # JWT Keys (should be set via .env file or environment variables)
      - JWT_PRIVATE_KEY=${JWT_PRIVATE_KEY}
      - JWT_PUBLIC_KEY=${JWT_PUBLIC_KEY}
      - JWT_EXPIRATION_MINUTES=60
      # RabbitMQ connection (required for Serilog event log streaming)
      - RABBITMQ_CONNECTION_STRING=amqp://admin:SecurePassword123!@rabbitmq:5672/
      # OpenTelemetry Collector connection (using service name in docker-compose)
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      # Admin user configuration
      - ADMIN_USERNAME=admin
      - ADMIN_PASSWORD=AdminPassword123!
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      otel-collector:
        condition: service_healthy
    # Healthcheck commented out - verify manually by accessing http://localhost:8080/health
    # The .NET image may not have curl/wget by default
    # healthcheck:
    #   test: ["CMD-SHELL", "exit 0"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 40s

  audit:
    image: boilerplate-services-audit:latest
    pull_policy: never
    build:
      context: .
      dockerfile: BoilerPlate.Services.Audit/Dockerfile
    container_name: boilerplate-services-audit
    restart: unless-stopped
    environment:
      # MongoDB connection (using service name in docker-compose)
      - MONGODB_CONNECTION_STRING=mongodb://admin:SecurePassword123!@mongodb:27017/logs?authSource=admin
      # RabbitMQ connection (using service name in docker-compose)
      - RABBITMQ_CONNECTION_STRING=amqp://admin:SecurePassword123!@rabbitmq:5672/
    depends_on:
      rabbitmq:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    # Healthcheck - just check if the process is running
    healthcheck:
      test: ["CMD-SHELL", "exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  event-logs:
    image: boilerplate-services-event-logs:latest
    pull_policy: never
    build:
      context: .
      dockerfile: BoilerPlate.Services.EventLogs/Dockerfile
    container_name: boilerplate-services-event-logs
    restart: unless-stopped
    environment:
      - MONGODB_CONNECTION_STRING=mongodb://admin:SecurePassword123!@mongodb:27017/logs?authSource=admin
      - RABBITMQ_CONNECTION_STRING=amqp://admin:SecurePassword123!@rabbitmq:5672/
    depends_on:
      rabbitmq:
        condition: service_healthy
      mongodb:
        condition: service_healthy

  diagnostics:
    image: boilerplate-diagnostics-webapi:latest
    pull_policy: never
    build:
      context: .
      dockerfile: BoilerPlate.Diagnostics.WebApi/Dockerfile
    container_name: boilerplate-diagnostics-api
    restart: unless-stopped
    environment:
      - ASPNETCORE_URLS=http://+:8080
      - JWT_PUBLIC_KEY=${JWT_PUBLIC_KEY}
      - JWT_ISSUER_URL=${JWT_ISSUER_URL:-http://webapi:8080}
      - JwtSettings__Issuer=BoilerPlate.Authentication
      - JwtSettings__Audience=BoilerPlate.API
      - MONGODB_CONNECTION_STRING=mongodb://admin:SecurePassword123!@mongodb:27017/logs?authSource=admin
      - RABBITMQ_CONNECTION_STRING=amqp://admin:SecurePassword123!@rabbitmq:5672/
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
    depends_on:
      webapi:
        condition: service_started
      mongodb:
        condition: service_healthy
      otel-collector:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  frontend:
    image: boilerplate-frontend:latest
    pull_policy: never
    build:
      context: .
      dockerfile: BoilerPlate.Frontend/Dockerfile
    container_name: boilerplate-frontend
    restart: unless-stopped
    ports:
      - "4200:443"
    volumes:
      - ./tls-certs/cert.pem:/etc/nginx/ssl/cert.pem:ro
      - ./tls-certs/key.pem:/etc/nginx/ssl/key.pem:ro
    depends_on:
      webapi:
        condition: service_started
      diagnostics:
        condition: service_started
      rabbitmq:
        condition: service_healthy

volumes:
  postgres_data:
  rabbitmq_data:
  mongodb_data:
  otel_collector_data: