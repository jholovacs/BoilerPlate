name: Unit Tests

on:
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      checks: write
      pull-requests: write
    
    strategy:
      matrix:
        dotnet-version: ['8.0.x']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ matrix.dotnet-version }}
        
    - name: Restore dependencies
      run: dotnet restore BoilerPlate.sln
      
    - name: Build solution
      run: dotnet build BoilerPlate.sln --configuration Release --no-restore
      
    - name: Run tests with coverage
      run: |
        dotnet test BoilerPlate.sln \
          --configuration Release \
          --no-build \
          --verbosity normal \
          --collect:"XPlat Code Coverage" \
          --results-directory:"${{ github.workspace }}/TestResults" \
          --logger:"trx;LogFileName=test-results.trx" \
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura,json,lcov \
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.ExcludeByAttribute="Obsolete,GeneratedCodeAttribute,CompilerGeneratedAttribute"
      
    - name: List coverage files
      if: always()
      run: |
        echo "Searching for coverage files in TestResults directory..."
        find "${{ github.workspace }}/TestResults" -type f \( -name "*.xml" -o -name "*.json" -o -name "*.cobertura" \) 2>/dev/null | head -20 || echo "No coverage files found"
        echo ""
        echo "TestResults directory structure:"
        find "${{ github.workspace }}/TestResults" -type f 2>/dev/null | head -20 || echo "TestResults directory not found"
      
    - name: Publish test results
      if: always()
      uses: EnricoMi/publish-unit-test-result-action@v2
      with:
        files: '${{ github.workspace }}/TestResults/**/*.trx'
        check_name: 'Unit Test Results'
        report_individual_runs: false
        fail_on: 'test failures'
      
    - name: Generate coverage report
      if: always()
      run: |
        # Find all coverage files
        COVERAGE_FILES=$(find "${{ github.workspace }}/TestResults" -type f \( -name "coverage.cobertura.xml" -o -name "coverage.xml" -o -name "*.cobertura.xml" \) 2>/dev/null | tr '\n' ';' | sed 's/;$//')
        
        if [ -z "$COVERAGE_FILES" ]; then
          echo "⚠️ No coverage files found. Skipping report generation."
          exit 0
        fi
        
        echo "Found coverage files: $COVERAGE_FILES"
        
        # Install ReportGenerator
        dotnet tool install -g dotnet-reportgenerator-globaltool
        
        # Generate report
        reportgenerator \
          -reports:"$COVERAGE_FILES" \
          -targetdir:"${{ github.workspace }}/CoverageReport" \
          -reporttypes:"Html;Badges;JsonSummary;Cobertura" \
          -verbosity:"Info" \
          -classfilters:"-*Tests*;-*Test*"
      
    - name: Upload test results artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: '${{ github.workspace }}/TestResults'
        retention-days: 30
        
    - name: Upload coverage report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: '${{ github.workspace }}/CoverageReport'
        retention-days: 30
        if-no-files-found: ignore
        
    - name: Coverage summary
      if: always()
      run: |
        if [ -f "${{ github.workspace }}/CoverageReport/Summary.json" ]; then
          echo "## Code Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          COVERAGE=$(jq -r '.summary.linecoverage // .linecoverage // 0' "${{ github.workspace }}/CoverageReport/Summary.json" 2>/dev/null || echo "0")
          echo "| Line Coverage | ${COVERAGE}% |" >> $GITHUB_STEP_SUMMARY
          BRANCH_COVERAGE=$(jq -r '.summary.branchcoverage // .branchcoverage // 0' "${{ github.workspace }}/CoverageReport/Summary.json" 2>/dev/null || echo "0")
          echo "| Branch Coverage | ${BRANCH_COVERAGE}% |" >> $GITHUB_STEP_SUMMARY
        else
          echo "## Code Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ Coverage report not available. This may be because no tests ran or coverage collection failed." >> $GITHUB_STEP_SUMMARY
        fi
