<div class="container">
  <div class="header">
    <h1>Audit Logs</h1>
    <button class="btn btn-secondary" (click)="logout()">Logout</button>
  </div>

  <div class="card">
    <div class="toolbar">
      <div class="toolbar-left">
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (keyup.enter)="search()"
          placeholder="Search by user, email, or event type..."
          class="search-input"
        />
        <input
          type="text"
          [(ngModel)]="eventTypeFilter"
          (keyup.enter)="search()"
          placeholder="Filter by event type..."
          class="search-input event-type-filter"
        />
        <button class="btn btn-primary" (click)="search()">Search</button>
        <button class="btn btn-secondary" (click)="clearSearch()">Clear</button>
      </div>
    </div>

    <div *ngIf="errorMessage" class="error-message">{{ errorMessage }}</div>

    <div *ngIf="isLoading" class="loading">Loading audit logs...</div>

    <div *ngIf="!isLoading && logs.length === 0" class="empty-state">
      {{ searchTerm || eventTypeFilter ? 'No logs match your filters.' : 'No audit logs found.' }}
    </div>

    <div *ngIf="!isLoading && logs.length > 0">
      <div class="pagination-info">{{ pageInfo }}</div>
      <table class="table">
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Event type</th>
            <th>User</th>
            <th>Email</th>
            <th>Event data</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let log of logs">
            <td class="col-timestamp">{{ formatTimestamp(getLogValue(log, 'eventTimestamp') ?? getLogValue(log, 'createdAt')) }}</td>
            <td>
              <span
                class="truncate-cell"
                [title]="getLogValue(log, 'eventType') || ''"
                (click)="openModal(getLogValue(log, 'eventType') || '', 'Event type')"
              >{{ getLogValue(log, 'eventType') || '-' }}</span>
            </td>
            <td>
              <span
                class="truncate-cell"
                [title]="getLogValue(log, 'userName') || ''"
                (click)="openModal(getLogValue(log, 'userName') || '', 'User')"
              >{{ getLogValue(log, 'userName') || '-' }}</span>
            </td>
            <td>
              <span
                class="truncate-cell"
                [title]="getLogValue(log, 'email') || ''"
                (click)="openModal(getLogValue(log, 'email') || '', 'Email')"
              >{{ getLogValue(log, 'email') || '-' }}</span>
            </td>
            <td class="col-event-data">
              <span
                *ngIf="getLogValue(log, 'eventData')"
                class="truncate-cell event-data-link"
                [title]="'View event data'"
                (click)="openModal(formatEventData(getLogValue(log, 'eventData')), 'Event data')"
              >{{ eventDataPreview(log) }}</span>
              <span *ngIf="!getLogValue(log, 'eventData')" class="muted">-</span>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="pagination">
        <button class="btn btn-secondary" [disabled]="!hasPrevPage" (click)="prevPage()">Previous</button>
        <span class="pagination-text">{{ pageInfo }}</span>
        <button class="btn btn-secondary" [disabled]="!hasNextPage" (click)="nextPage()">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for full text view with copy -->
<div *ngIf="modalVisible" class="modal-overlay" (click)="closeModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ modalTitle }}</h3>
      <button type="button" class="modal-close" (click)="closeModal()" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <pre class="modal-content" [innerHTML]="modalContent | entityIds"></pre>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-primary" (click)="copyToClipboard()">
        {{ copyFeedback ? 'Copied!' : 'Copy to clipboard' }}
      </button>
      <button type="button" class="btn btn-secondary" (click)="closeModal()">Close</button>
    </div>
  </div>
</div>
