# BoilerPlate Kubernetes Manifests

Kubernetes manifests for deploying BoilerPlate to a cluster.

## Quick Install

Use the root-level install script for guided installation:

```bash
./install-k8s.sh
```

The script prompts for:
- Namespace, domain, image registry
- **PostgreSQL**: Internal (deployed in cluster) or external (your managed instance, e.g. Azure Database, AWS RDS)
- **MongoDB**: Internal or external (e.g. MongoDB Atlas, Azure Cosmos DB). When external, you can specify separate connections for audit logs vs event logs.
- **RabbitMQ**: Internal or external (e.g. CloudAMQP, Amazon MQ)
- Passwords (for internal services), TLS options

## Manual Install

### Prerequisites

- `kubectl` configured for your cluster
- nginx Ingress Controller
- Container images built and pushed to a registry

### 1. Create secrets

```bash
kubectl create namespace boilerplate

kubectl create secret generic boilerplate-secrets -n boilerplate \
  --from-literal=postgres-password='...' \
  --from-literal=rabbitmq-password='...' \
  --from-literal=mongodb-password='...' \
  --from-literal=admin-username=admin \
  --from-literal=admin-password='...' \
  --from-literal=postgres-connection='Host=postgres;Port=5432;Database=BoilerPlateAuth;Username=boilerplate;Password=...' \
  --from-literal=audit-logs-mongodb-connection='mongodb://admin:...@mongodb:27017/audit?authSource=admin' \
  --from-literal=event-logs-mongodb-connection='mongodb://admin:...@mongodb:27017/logs?authSource=admin' \
  --from-literal=rabbitmq-connection='amqp://admin:...@rabbitmq:5672/' \
  --from-literal=jwt-private-key='<base64>' \
  --from-literal=jwt-public-key='<base64>' \
  --from-literal=jwt-issuer-url='https://your-domain.com'
```

### 2. Create TLS secret (if not using cert-manager)

```bash
kubectl create secret tls boilerplate-tls -n boilerplate \
  --cert=path/to/cert.pem \
  --key=path/to/key.pem
```

### 3. Apply with Kustomize

```bash
# Edit k8s/overlays/production/kustomization.yaml to set images and domain
kubectl apply -k k8s/overlays/production
```

### 4. Run migrations

```bash
kubectl port-forward -n boilerplate svc/postgres 5432:5432 &
# From project root:
make migrate POSTGRES_PASSWORD=yourpassword
```

## Structure

- `base/` – Base manifests (namespace, configmaps, deployments, services, ingress)
- `overlays/production/` – Generated by `install-k8s.sh` with your settings

## Cluster DNS Resolver

The frontend nginx config uses `resolver 10.96.0.10` (common CoreDNS). If your cluster uses a different DNS, edit `configmap-frontend-nginx.yaml` and update the resolver.
